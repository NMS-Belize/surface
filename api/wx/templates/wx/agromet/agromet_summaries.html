{% extends "base.html" %} {% block content %} {% load static %} {% load material_form %}

<div class="srf-container">
	<div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
		<span class="srf-display-1 text-uppercase">Agromet Summaries</span><br /><br />
	</div>
	<div class="srf-flex justify-content-between srf-padding" id="app">
		<v-app>
			<v-overlay :value="loading_data">
				<v-card flat light style="background-color: transparent;">
					<v-card-title class="text-center"> Loading Data... </v-card-title>
					<v-card-actions class="text-center justify-center">
					  <v-progress-circular indeterminate color="primary"/>
					</v-card-actions>
				</v-card>
			</v-overlay>

			<form enctype="multipart/form-data" method="POST" class="mb-10">
				{% csrf_token %}
				<v-row>
					<v-col cols="2" class="d-flex justify-center">
						<v-switch 
							v-model="filters.is_automatic"
							:label='filters.is_automatic?"Automatic Stations":"Manual Stations"'
							inset
						/>
					</v-col>
					<v-col cols="4">
						<v-autocomplete
							label="Select Station"
							:items="filteredStationList"
							item-value="id"
							item-text="name"
							v-model="requestData.stationId"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="6">
						<v-autocomplete
							label="Select Variables"
							:items="filteredVariableList"
							item-value="id"
							item-text="name"
							v-model="requestData.variableIds"
							required
							hint="*Required"
							multiple
							chips
							clearable
							persistent-hint
							deletable-chips
							:disabled="!requestData.stationId"
						/>
					</v-col>
				</v-row>
				<v-row>
					<v-col cols="2">
						<v-autocomplete
							label="Select Start Year"
							:items="availableStartYears"
							v-model="requestData.startYear"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>	
					<v-col cols="2">
						<v-autocomplete
							label="Select End Year"
							:items="availableEndYears"
							v-model="requestData.endYear"
							required
							hint="*Required"
							persistent-hint
							:disabled="!requestData.startYear"
						/>
					</v-col>
					<v-col cols="3" class="d-flex justify-center">
						<v-switch
							v-model="filters.is_season"
							:label='filters.is_season?"Seasonal Summary":"Monthly Summary"'
							inset
					  	/> 						  
					</v-col>
					<v-col cols="3" v-if="requestData.summaryType==='Month'">
						<v-autocomplete
							label="Select Months"
							:items="months"
							item-value='id'
							item-text="name"
							v-model="requestData.months"
							required
							hint="*Required"
							persistent-hint
							multiple
							clearable
							chips
							deletable-chips
						/>
					</v-col>					
					<v-col cols="2" v-if="requestData.summaryType==='Month'">
						<v-autocomplete
							label="Select Interval"
							:items="intervals"
							v-model="requestData.interval"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
				</v-row>
				<v-row>				
					<v-col cols="2" class="d-flex justify-left">
						<v-btn
							@click="getData"
							:disabled="disableQuery"							
							> Request Data <v-icon right>send</v-icon> </v-btn>
					</v-col>											
				</v-row>					
			</form>


			
			<div>				
				<template>
					<v-card v-if="requestedData.responseData && !loading_data">
						<v-tabs v-model="tab" bg-color="primary" class="justify-center">
							<v-tab v-for="variableId in requestedData.variableIds" :key="variableId" :value="variableId">
								[[ variableList.find(variable => variable.id==variableId)?.name ]]
							</v-tab>
						</v-tabs>
				
						<v-card-title> [[ ]] </v-card-title>
						<v-card-text>
							<template>
								<v-data-table
									:headers="dataTable.headers"
									:items="dataTable.data"
								></v-data-table>
							</template>
						</v-card-text>
						<v-card-actions>
							<v-btn
								@click="downloadCSV"
								> Download CSV <v-icon right>download</v-icon> </v-btn>
						</v-card-actions
					</v-card>					
				</template>	
			</div>
		</v-app>
	</div>
</div>

{% endblock %} {% block localjavascript %}
 
<script>
	Vue.use(window.vuelidate.default);
	const { required, minLength } = window.validators;

	new Vue({
		el: "#app",
		vuetify: new Vuetify(),
		delimiters: ["[[", "]]"],
		validations: {
		},
		data: {
			now: moment().format('YYYY-MM-DD'),
			tab: null,
			loading_data: false,
			requestData: {
				stationId: {{station_id}},
				variableIds: {{variable_ids | safe}},
				summaryType: 'Season',
				months: [],
				interval: null,
				startYear: null,
				endYear: null,
			},
			requestedData: {
				stationId: null,
				variableIds: [],
				summaryType: 'Season',
				months: [],
				interval: null,
				startYear: null,
				endYear: null,
				responseData: null,
			},
			filters: {
				is_season: true,
				is_automatic: true
			},
			start_year_menu: false,
			end_year_menu: false,
			summaryTypes: ['Month', 'Season'],
			months: [
				{id: 1, name: 'Jan'},
				{id: 2, name: 'Feb'},
				{id: 3, name: 'Mar'},
				{id: 4, name: 'Apr'},
				{id: 5, name: 'May'},
				{id: 6, name: 'Jun'},
				{id: 7, name: 'Jul'},
				{id: 8, name: 'Aug'},
				{id: 9, name: 'Sep'},
				{id: 10, name: 'Oct'},
				{id: 11, name: 'Nov'},
				{id: 12, name: 'Dec'},
			],
			intervals: ['7 days', '10 days'],
			variableList: {{ variable_list | safe }},
			stationList: [
				{% for station in station_list %}
					{id: {{station.id}}, name: "{{station.name | safe }} - {{station.code}}", is_automatic:  {{station.is_automatic|yesno:"true,false"}}},
				{% endfor %}
			]
		},
		watch: {
			'requestData.summaryType' (newSummaryType, oldSummaryType){
				this.requestData.months = []
			},
			'filters.is_automatic' (newValue, oldValue) {
				this.requestData.stationId = null
			},
			'filters.is_season' (newValue, oldValue) {
				this.requestData.summaryType = newValue?'Season':'Month'
			},
			'requestData.stationId' (newStationId, oldStationId) {
				this.requestData.variableIds = []
			},
			'requestData.startYear' (newStartYear, oldStartYear) {
				this.requestData.endYear = null
			}
		},	
		computed: {
			availableStartYears () {
				const min_year = 1900
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			availableEndYears () {
				if (!this.requestData.startYear) return [];
				const min_year = this.requestData.startYear
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			disableQuery (){
				const { variableIds, summaryType, months, season, interval, ...rest } =  this.requestData
				if (['stationId', 'startYear', 'endYear'].some(key => rest[key] === null)) return true
				if ((variableIds === null) || (variableIds.length === 0)) return true;
				if (summaryType === 'Month' && ((months === null) || (months.length === 0) || (interval === null))) return true;

				return false
			},
			filteredStationList() {
				return this.stationList.filter(station=>station.is_automatic===this.filters.is_automatic)
			},
			filteredVariableList() {
				if (!this.requestData.stationId) return [];
		
				const stationvariableList = {{ stationvariable_list | safe }};
				const variableList = {{ variable_list | safe }};
		
				const stationVariableIds = stationvariableList
					.filter(stationvariable => stationvariable.station_id == this.requestData.stationId)
					.map(stationvariable => stationvariable.variable_id);
				
				return variableList.filter(variable => stationVariableIds.includes(variable.id));
			},
			dataTable () {
				let selectedVariableId = null
				let filteredData = []
				if (!(this.tab===null)){
					selectedVariableId = this.requestedData.variableIds[this.tab];
					filteredData = this.requestedData.responseData.filter(entry => entry.variable_id===selectedVariableId);
				}
				

				if (this.requestedData.summaryType==='Season'){
					const baseKeys = ['station', 'variable_id', 'year']
					const keys = filteredData.length? Object.keys(filteredData[0]).filter(item => !baseKeys.includes(item)): [];
					
					const baseHeaders = [
						{ text: 'Year', align: 'end', value: 'year' }
					];
					
					const calcHeaders = keys.map(item => ({
						text: item,
						align: 'end',
						value: item
					}));
					
					return {
						headers: [...baseHeaders, ...calcHeaders],
						data: filteredData
					};
				}
				else if (this.requestedData.summaryType==='Month'){
					if (this.requestedData.interval==='7 days'){
						return {
							headers: [
								{ text: 'Year', align: 'end', value: 'year' },
								{ text: 'Month', align: 'end', value: 'month' },
								{ text: 'days 01-07', align: 'end', value: 'agg_1' },
								{ text: 'days 08-14', align: 'end', value: 'agg_2' },
								{ text: 'days 15-21', align: 'end', value: 'agg_3' },
								{ text: 'days 22-', align: 'end', value: 'agg_4' },
							],
							data: filteredData
						}
					}
					else if (this.requestedData.interval==='10 days'){
						return {
							headers: [
								{ text: 'Year', align: 'end', value: 'year' },
								{ text: 'Month', align: 'end', value: 'month' },
								{ text: 'days 01-10', align: 'end', value: 'agg_1' },
								{ text: 'days 11-20', align: 'end', value: 'agg_2' },
								{ text: 'days 21-', align: 'end', value: 'agg_3' },
							],
							data: filteredData
						}
					}
				}
			},
		},
		methods: { 
			clearSelectedVariables (){
				this.requestData.variableIds = []
			},
			getData(){
				this.loading_data = true

				this.requestedData.stationId = this.requestData.stationId
				this.requestedData.variableIds = this.requestData.variableIds
				this.requestedData.months = this.requestData.months
				this.requestedData.interval = this.requestData.interval
				this.requestedData.startYear = this.requestData.startYear
				this.requestedData.endYear = this.requestData.endYear
				this.requestedData.summaryType = this.requestData.summaryType
				this.requestedData.responseData = null

				const url = `/wx/agromet/summaries/get/`
				console.log(this.requestedData.months.join(','),)

				const params = {
					station_id: this.requestedData.stationId,
					variable_ids: this.requestedData.variableIds.join(','),
					months: this.requestedData.months.join(','),
					interval: this.requestedData.interval,
					start_year: this.requestedData.startYear,
					end_year: this.requestedData.endYear,
					summary_type: this.requestedData.summaryType
				};

        		axios.get(url, { params })
				.then(response => {
					this.requestedData.responseData = response.data;
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				})
				.finally(() => {
					this.loading_data = false
				});

			},
			convertToCSV(data) {
				const headers = data.headers.map(item => item.text).join(',') + '\n';

				const indicesToRemove = [0,1] // Exclude the StationID and VariableID columns
				const rows = data.data.map(row => 
				  Object.values(row)
					.filter((value, index) => !indicesToRemove.includes(index)) 
					.map(value => `"${value}"`)
					.join(',')
				).join('\n');

				return headers + rows;
			},
			downloadCSV() {
				const csvContent = this.convertToCSV(this.dataTable);
				const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
				const link = document.createElement('a');

				const { stationId, variableIds, summaryType, startYear, endYear, interval, ...rest } = this.requestedData;

				const selectedVariableId = variableIds[this.tab];
				const station = this.stationList.find(station => station.id === stationId)
				const variable = this.variableList.find(variable => variable.id === selectedVariableId)
						
				const filename = summaryType === 'Month' 
  					? `agromet-summary-(${summaryType})-${station?.name}-${variable?.symbol}-${startYear}-${endYear}-[${interval}].csv`
  					: `agromet-summary-(${summaryType})-${station?.name}-${variable?.symbol}-${startYear}-${endYear}.csv`;
			
				link.href = URL.createObjectURL(blob);
				link.download = filename;
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}
		},
		mounted() {
		}
	})
	
	$(document).ready(function(){
		function getCookie(c_name) {
			if(document.cookie.length > 0) {
				c_start = document.cookie.indexOf(c_name + "=");
				if(c_start != -1) {
					c_start = c_start + c_name.length + 1;
					c_end = document.cookie.indexOf(";", c_start);
					if(c_end == -1) c_end = document.cookie.length;
					return unescape(document.cookie.substring(c_start,c_end));
				}
			}
			return "";
		}
	
		$(function () {
		  axios.defaults.headers.common["X-CSRFToken"] = getCookie("csrftoken");
		  axios.defaults.headers.common["Content-Type"] = 'application/json';
		});
	});
</script>
{% endblock %}