{% extends "base.html" %} {% block content %} {% load static %} {% load material_form %}

<div class="srf-container">
	<div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
		<span class="srf-display-1 text-uppercase">Agromet Summaries</span><br /><br />
	</div>
	<div class="srf-flex justify-content-between srf-padding" id="app">
		<v-app>
			<v-overlay :value="loading_data">
				<v-card flat light style="background-color: transparent;">
					<v-card-title class="text-center"> Loading Data... </v-card-title>
					<v-card-actions class="text-center justify-center">
					  <v-progress-circular indeterminate color="primary"/>
					</v-card-actions>
				</v-card>
			</v-overlay>

			<form enctype="multipart/form-data" method="POST" class="mb-10">
				{% csrf_token %}
				<v-row>
					<v-col cols="3">
						<v-autocomplete
							label="Select Station"
							:items="stationList"
							item-value="id"
							item-text="name"
							v-model="requestData.stationId"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
                    <v-col cols="3">
                        <v-autocomplete
							label="Select Element"
							:items="Object.keys(elements)"
							v-model="requestData.element"
							required
							hint="*Required"
							persistent-hint
						/>
                    </v-col>
					<v-col cols="2">
                        <v-autocomplete
							label="Select Product"
							:items="elements[requestData.element]"
							v-model="requestData.product"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="2" v-if="requireNumericParam">
						<v-text-field
							v-model="requestData.numericParam"
							:rules="[rules.required, rules.numeric]"
							label="Numeric Parameter"
						/>
				</v-row>
				<v-row>
					<v-col cols="2">
						<v-autocomplete
							label="Select Start Year"
							:items="availableStartYears"
							v-model="requestData.startYear"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>	
					<v-col cols="2">
						<v-autocomplete
							label="Select End Year"
							:items="availableEndYears"
							v-model="requestData.endYear"
							required
							hint="*Required"
							persistent-hint
							:disabled="!requestData.startYear"
						/>
					</v-col>
					<v-col cols="2" class="d-flex justify-center">
						<v-btn
							@click="getData"
							:disabled="disableQuery"						
							> Request Data <v-icon right>send</v-icon> </v-btn>
					</v-col>	                    
				</v-row>				
			</form>	
		</v-app>
	</div>
</div>

{% endblock %} {% block localjavascript %}
 
<script>
	Vue.use(window.vuelidate.default);
	const { required, numeric } = window.validators;

	new Vue({
		el: "#app",
		vuetify: new Vuetify(),
		delimiters: ["[[", "]]"],
		validations: {
			requestData: {
                stationId: { required },
                element: { required },
                product: { required },
                numericParam: { required, numeric },
                startYear: { required },
                endYear: { required }
            }			
		},
		data: {
			now: moment().format('YYYY-MM-DD'),
			loading_data: false,
			rules: {
				required: value => (!!value && value.trim() !== '')|| 'Required.',
				numeric: value => (!isNaN(value) ) || 'Parameter must be a Numeric.',
			},			
			requestData: {
				stationId: {{station_id}},
                element: null,
				product: null,
				numericParam: null,
				startYear: null,
				endYear: null,
			},
			requestedData: {
				stationId: null,
                element: null,
				product: null,
				numericParam: null,
				startYear: null,
				endYear: null,
				responseData: null,
			},
			elements: {
				'Air Temperature': [
					'Degree days',
					'Maximum and minimum statistics',
					'Hours or days above or below selected temperature',
					'Growing season statistics',
				],
			   'Rainfall': [
					'Number of days with specified amount of rainfall',
					'Drought indices ',
					'Flood and excess rainfall',
			   ],
				'Wind': [
					'Wind Rose',
					'Maximum Wind and Average Wind speed',
					'Diurnal variation',
					'Hours of wind less than a selected speed',
					'Sunshine/Radiation',
					'Amounts of global and net radiation',
					'Sunshine and radiation hours',
				],
				'Relative Humidity': [
					'Duration of a specified threshold of humidity',
				],
				'Free Water Evaporation / Evapotranspiration': [
					'Total amount',
					'Diurnal variation of evaporation',
					'Evapotranspiration',
				],
				'Soil Temperature':[
					'Mean and standard deviation at standard depth;',
					'Dates when threshold values of temperature (germination, vegetation) are reached.',
					'Soil Moisture',
					'Soil Moisture at regular depths',
					'Leaf area index',
				]
			},
			start_year_menu: false,
			end_year_menu: false,
			stationList: [
				{% for station in station_list %}
					{id: {{station.id}}, name: "{{station.name | safe }} - {{station.code}}"},
				{% endfor %}
			],
		},
		watch: {
			'requestData.startYear' (newStartYear, oldStartYear) {
				this.requestData.endYear = null
			}
		},	
		computed: {
			requireNumericParam (){
				const productList = [
					'Degree days',
					'Hours or days above or below selected temperature',
				]
				return productList.includes(this.requestData.product)
			},
			availableStartYears () {
				const min_year = 1900
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			availableEndYears () {
				if (!this.requestData.startYear) return [];
				const min_year = this.requestData.startYear
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			disableQuery (){
				const { numericParam, ...rest } =  this.requestData
				if (Object.keys(rest).some(key => rest[key] === null)) return true
				if (this.requireNumericParam && numericParam === null) return true
				return false
			},	
		},
		methods: {
            getData(){
				this.loading_data = true

				this.requestedData.stationId = this.requestData.stationId
				this.requestedData.startYear = this.requestData.startYear
				this.requestedData.endYear = this.requestData.endYear
				this.requestedData.element = this.requestData.element
				this.requestedData.product = this.requestData.product
				this.requestedData.numericParam = this.requestData.numericParam
				this.requestedData.responseData = null

				const url = `/wx/agromet/products/get/`

				const params = {
					station_id: this.requestedData.stationId,
					start_year: this.requestedData.startYear,
					end_year: this.requestedData.endYear,
					element: this.requestedData.element,
					product: this.requestedData.product,
					numericParam: this.requestedData.numericParam,
				};

        		axios.get(url, { params })
				.then(response => {
					console.log('Return Data:', response.data)
					this.requestedData.responseData = response.data;
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				})
				.finally(() => {
					this.loading_data = false
				});
			}
		}		
	})
</script>
{% endblock %}
