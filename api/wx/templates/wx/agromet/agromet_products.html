{% extends "base.html" %} {% block content %} {% load static %} {% load material_form %}

<div class="srf-container">
	<div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
		<span class="srf-display-1 text-uppercase">Agromet Products</span><br /><br />
	</div>
	<div class="srf-flex justify-content-between srf-padding" id="app">
		<v-app>
			<v-overlay :value="loading_data">
				<v-card flat light style="background-color: transparent;">
					<v-card-title class="text-center"> Loading Data... </v-card-title>
					<v-card-actions class="text-center justify-center">
					  <v-progress-circular indeterminate color="primary"/>
					</v-card-actions>
				</v-card>
			</v-overlay>

			<form enctype="multipart/form-data" method="POST" class="mb-10">
				{% csrf_token %}
				<v-row>
					<v-col cols="2" class="d-flex justify-center">
						<v-switch 
							v-model="filters.is_automatic"
							:label='filters.is_automatic?"Automatic Stations":"Manual Stations"'
							inset
						/>
					</v-col>				
					<v-col cols="3">
						<v-autocomplete
							label="Select Station"
							:items="filteredStationList"
							item-value="id"
							item-text="name"
							v-model="requestData.stationId"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
                    <v-col cols="3">
                        <v-autocomplete
							label="Select Element"
							:items="Object.keys(elements)"
							v-model="requestData.element"
							required
							hint="*Required"
							persistent-hint
						/>
                    </v-col>
					<v-col cols="2">
                        <v-autocomplete
							label="Select Product"
							:items="elements[requestData.element]"
							v-model="requestData.product"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
				</v-row>
				<v-row>
					<v-col cols="2" v-if="requireNumericParam">
						<v-text-field
							v-model="requestData.numericParam"
							:rules="[rules.required, rules.numeric]"
							label="Numeric Parameter"
						/>
					<v-col>					
				</v-row>
				<v-row>
					<v-col cols="2">
						<v-autocomplete
							label="Select Start Year"
							:items="availableStartYears"
							v-model="requestData.startYear"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="2">
						<v-autocomplete
							label="Select End Year"
							:items="availableEndYears"
							v-model="requestData.endYear"
							required
							hint="*Required"
							persistent-hint
							:disabled="!requestData.startYear"
						/>
					</v-col>
					<v-col cols="3" class="d-flex justify-center">
						<v-switch
							v-model="filters.is_seasonal"
							:label='filters.is_seasonal?"Seasonal Summary":"Monthly Summary"'
							inset
					  	/>
					</v-col>
					<v-col cols="3" v-if="requestData.summaryType==='Monthly'">
						<v-autocomplete
							label="Select Months"
							:items="months"
							item-value='id'
							item-text="name"
							v-model="requestData.months"
							required
							hint="*Required"
							persistent-hint
							multiple
							clearable
							chips
							deletable-chips
						/>
					</v-col>					
					<v-col cols="2" v-if="requestData.summaryType==='Monthly'">
						<v-autocomplete
							label="Select Interval"
							:items="intervals"
							v-model="requestData.interval"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
				</v-row>
				<v-row>
					<v-col cols="2" class="d-flex justify-center">
						<v-btn @click="getData" :disabled="disableQuery">
							Request Dat
							<v-icon right>send</v-icon>
						</v-btn>
					</v-col>
				</v-row>
			</form>	

			<div>				
				<template>
					<v-card v-if="requestedData.responseData && !loading_data">
						<v-card-title class="text-center"> [[ requestedData.product ]] </v-card-title>
						<v-card-text>
							<template>
								<v-data-table
									:headers="dataTable.headers"
									:items="dataTable.data"
								></v-data-table>
							</template>
						</v-card-text>
						<v-card-actions>
							<v-btn @click="downloadCSV">
								Download CSV 
								<v-icon right>download</v-icon>
							</v-btn>
						</v-card-actions
					</v-card>					
				</template>	
			</div>			
		</v-app>
	</div>
</div>

{% endblock %} {% block localjavascript %}
 
<script>
	Vue.use(window.vuelidate.default);
	const { required, numeric } = window.validators;

	new Vue({
		el: "#app",
		vuetify: new Vuetify(),
		delimiters: ["[[", "]]"],
		validations: {
			requestData: {
                stationId: { required },
                element: { required },
                product: { required },
                numericParam: { required, numeric },
                startYear: { required },
                endYear: { required }
            }			
		},
		data: {
			now: moment().format('YYYY-MM-DD'),
			loading_data: false,
			rules: {
				required: value => (!!value && value.trim() !== '')|| 'Required.',
				numeric: value => (!isNaN(value) ) || 'Parameter must be a Numeric.',
			},			
			requestData: {
				stationId: {{station_id}},
                element: null,
				product: null,
				numericParam: null,
				startYear: null,
				endYear: null,
				summaryType: 'Seasonal',
				months: [],
				interavl: null,
			},
			requestedData: {
				stationId: null,
                element: null,
				product: null,
				numericParam: null,
				startYear: null,
				endYear: null,
				responseData: null,
				summaryType: 'Seasonal',
				months: [],
				interavl: null,				
			},
			filters: {
				is_automatic: true,
				is_seasonal: true
			},			
			elements: {
				'Air Temperature': [
					'Degree days',
					'Maximum and minimum statistics',
					'Hours or days above or below selected temperature',
					'Growing season statistics',
				],
			   'Rainfall': [
					'Number of days with specified amount of rainfall',
					'Drought indices ',
					'Flood and excess rainfall',
			   ],
				'Wind': [
					'Wind Rose',
					'Maximum Wind and Average Wind speed',
					'Diurnal variation',
					'Hours of wind less than a selected speed',
					'Sunshine/Radiation',
					'Amounts of global and net radiation',
					'Sunshine and radiation hours',
				],
				'Relative Humidity': [
					'Duration of a specified threshold of humidity',
				],
				'Free Water Evaporation / Evapotranspiration': [
					'Total amount',
					'Diurnal variation of evaporation',
					'Evapotranspiration',
				],
				'Soil Temperature':[
					'Mean and standard deviation at standard depth;',
					'Dates when threshold values of temperature (germination, vegetation) are reached.',
					'Soil Moisture',
					'Soil Moisture at regular depths',
					'Leaf area index',
				]
			},
			start_year_menu: false,
			end_year_menu: false,
			intervals: ['7 days', '10 days'],
			months: [
				{id: 1, name: 'Jan'},
				{id: 2, name: 'Feb'},
				{id: 3, name: 'Mar'},
				{id: 4, name: 'Apr'},
				{id: 5, name: 'May'},
				{id: 6, name: 'Jun'},
				{id: 7, name: 'Jul'},
				{id: 8, name: 'Aug'},
				{id: 9, name: 'Sep'},
				{id: 10, name: 'Oct'},
				{id: 11, name: 'Nov'},
				{id: 12, name: 'Dec'},
			],
			stationList: [
				{% for station in station_list %}
					{id: {{station.id}}, name: "{{station.name | safe }} - {{station.code}}", is_automatic:  {{station.is_automatic|yesno:"true,false"}}},
				{% endfor %}
			],
		},
		watch: {
			'requestData.startYear' (newStartYear, oldStartYear) {
				this.requestData.endYear = null
			},
			'filters.is_automatic' (newValue, oldValue) {
				this.requestData.stationId = null
			},
			'filters.is_seasonal' (newValue, oldValue) {
				this.requestData.summaryType = newValue?'Seasonal':'Monthly'
			},
		},	
		computed: {
			filteredStationList() {
				return this.stationList.filter(station=>station.is_automatic===this.filters.is_automatic)
			},			
			requireNumericParam (){
				const productList = [
					'Degree days',
					'Hours or days above or below selected temperature',
				]
				return productList.includes(this.requestData.product)
			},
			availableStartYears () {
				const min_year = 1900
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			availableEndYears () {
				if (!this.requestData.startYear) return [];
				const min_year = this.requestData.startYear
				const max_year = moment().year()
				return Array.from({ length: max_year - min_year + 1 }, (_, i) => max_year - i);
			},
			disableQuery (){
				const { numericParam, ...rest } =  this.requestData
				if (Object.keys(rest).some(key => rest[key] === null)) return true
				if (this.requireNumericParam && numericParam === null) return true
				return false
			},
			dataTable () {
				let selectedVariableId = null
				let filteredData = []
				let data = this.requestedData.responseData

				const { element, product, ...rest } = this.requestedData

				if (element==='Air Temperature'){
					if (product==='Degree days'){
						return {
							headers: [
								{ text: 'Year', align: 'end', value: 'year' },
								{ text: 'Heating Degree Days', align: 'end', value: 'hdd' },
								{ text: 'Cooling Degree Days', align: 'end', value: 'cdd' }
							],
							data: data
						};
					}
					else if (product==='Hours or days above or below selected temperature'){
						return {
							headers: [
								{ text: 'Year', align: 'end', value: 'year' },
								{ text: 'Days Below Value', align: 'end', value: 'below' },
								{ text: 'Days Above Value', align: 'end', value: 'above' }
							],
							data: data
						}
					}
				}
			}			
		},
		methods: {
            getData(){
				this.loading_data = true

				this.requestedData.stationId = this.requestData.stationId
				this.requestedData.startYear = this.requestData.startYear
				this.requestedData.endYear = this.requestData.endYear
				this.requestedData.element = this.requestData.element
				this.requestedData.product = this.requestData.product
				this.requestedData.numericParam = this.requestData.numericParam
				this.requestedData.responseData = null

				const url = `/wx/agromet/products/get/`

				const params = {
					station_id: this.requestedData.stationId,
					start_year: this.requestedData.startYear,
					end_year: this.requestedData.endYear,
					element: this.requestedData.element,
					product: this.requestedData.product,
					numeric_param: this.requestedData.numericParam,
				};

        		axios.get(url, { params })
				.then(response => {
					console.log('Return Data:', response.data)
					this.requestedData.responseData = response.data;
				})
				.catch(error => {
					console.error('Error fetching data:', error);
				})
				.finally(() => {
					this.loading_data = false
				});
			},
			convertToCSV(data) {
				const headers = data.headers.map(item => item.text).join(',') + '\n';

				const indicesToRemove = [] // Exclude columns
				const rows = data.data.map(row => 
				  Object.values(row)
					.filter((value, index) => !indicesToRemove.includes(index)) 
					.map(value => `"${value}"`)
					.join(',')
				).join('\n');

				return headers + rows;
			},
			downloadCSV() {
				const csvContent = this.convertToCSV(this.dataTable);
				const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
				const link = document.createElement('a');

				// const { stationId, variableIds, summaryType, startYear, endYear, interval, ...rest } = this.requestedData;

				//  const selectedVariableId = variableIds[this.tab];
				//  const station = this.stationList.find(station => station.id === stationId)
				//  const variable = this.variableList.find(variable => variable.id === selectedVariableId)
						
				//  const filename = summaryType === 'Monthly' 
  				// 	? `agromet-summary-(${summaryType})-${station?.name}-${variable?.symbol}-${startYear}-${endYear}-[${interval}].csv`
  				// 	: `agromet-summary-(${summaryType})-${station?.name}-${variable?.symbol}-${startYear}-${endYear}.csv`;
			
				let filename = 'agromet-product'
				link.href = URL.createObjectURL(blob);
				link.download = filename;
				link.style.visibility = 'hidden';
				document.body.appendChild(link);
				link.click();
				document.body.removeChild(link);
			}			
		}		
	})
</script>
{% endblock %}
