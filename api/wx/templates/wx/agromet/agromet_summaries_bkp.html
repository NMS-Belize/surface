{% extends "base.html" %} {% block content %} {% load static %} {% load material_form %}

<div class="srf-container">
	<div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
		<span class="srf-display-1 text-uppercase">Agromet Summaries</span><br /><br />
	</div>
	<div class="srf-flex justify-content-between srf-padding" id="app">
		<v-app>
			<form enctype="multipart/form-data" method="POST" class="mb-10">
				{% csrf_token %}
				<v-row>
					<v-col cols="4">
						<v-autocomplete
							label="Select Station"
							:items="stationList"
							item-value="id"
							item-text="name"
							v-model="requestData.stationId"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="8">
						<v-autocomplete
							label="Select Variables"
							:items="filteredVariableList"
							item-value="id"
							item-text="name"
							v-model="requestData.variableIds"
							required
							hint="*Required"
							multiple
							chips
							clearable
							persistent-hint
							deletable-chips
							:disabled="!requestData.stationId"
						/>
					</v-col>
				</v-row>
				<v-row>
					<v-col cols="2">
						<v-radio-group v-model="radioGroup" row label="Select an Option">
							<v-radio
								v-for="(agregation, index) in agregations"
								:key="index"
								:label="agregation"
								:value="agregation"
							></v-radio>
						</v-radio-group>
					</v-col>
					<v-col cols="2" v-if="radioGroup==='Month'">
						<v-autocomplete
							label="Select Month"
							:items="months"
							v-model="month"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="2" v-if="radioGroup==='Season'">
						<v-autocomplete
							label="Select Season"
							:items="seasons"
							v-model="season"
							required
							hint="*Required"
							persistent-hint
						/>		
					</v-col>				
					<v-col cols="2">
						<v-menu
							:close-on-content-click="false"
							v-model="latest_month_menu"
							:nudge-right="40"
							transition="scale-transition"
							offset-y
							class="max-50"
						>
							<template v-slot:activator="{ on }">
								<v-text-field
									v-model="requestData.latestMonth"
									label="Latest Month"
									prepend-icon="event"
									v-on="on"
									required
									hint="*Required"
									persistent-hint
								></v-text-field>
							</template>
							<v-date-picker
								v-model="requestData.latestMonth"
								type="year"
								@input="latest_month_menu = false"
								:allowed-dates="allowedlatestMonths"
							/>
						</v-menu>	
					</v-col>
					<v-col cols="2">
						<v-menu
							:close-on-content-click="false"
							v-model="latest_month_menu"
							:nudge-right="40"
							transition="scale-transition"
							offset-y
							class="max-50"
						>
							<template v-slot:activator="{ on }">
								<v-text-field
									v-model="requestData.latestMonth"
									label="Latest Month"
									prepend-icon="event"
									v-on="on"
									required
									hint="*Required"
									persistent-hint
								></v-text-field>
							</template>
							<v-date-picker
								v-model="requestData.latestMonth"
								type="year"
								@input="latest_month_menu = false"
								:allowed-dates="allowedlatestMonths"
							/>
						</v-menu>	
					</v-col>
					<v-col cols="2">
						<v-autocomplete
							label="Select Aggregation Interval"
							:items="intervals"
							v-model="requestData.interval"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="2" class="d-flex justify-center">
						<v-btn
							@click="getData"
							{% comment %} :disabled="Object.values(requestData).includes(null) || !requestData.variableIds.length"							 {% endcomment %}
							> Request Data <v-icon right>send</v-icon> </v-btn>
					</v-col>											
				</v-row>
				<v-row>
					<v-col cols="4">
						<v-menu
							:close-on-content-click="false"
							v-model="latest_month_menu"
							:nudge-right="40"
							transition="scale-transition"
							offset-y
							class="max-50"
						>
							<template v-slot:activator="{ on }">
								<v-text-field
									v-model="requestData.latestMonth"
									label="Latest Month"
									prepend-icon="event"
									v-on="on"
									required
									hint="*Required"
									persistent-hint
								></v-text-field>
							</template>
							<v-date-picker
								v-model="requestData.latestMonth"
								type="month"
								@input="latest_month_menu = false"
								:allowed-dates="allowedlatestMonths"
							/>
						</v-menu>
					</v-col>
					<v-col cols="4">
						<v-menu
							:close-on-content-click="false"
							v-model="earliest_month_menu"
							:nudge-right="40"
							transition="scale-transition"
							offset-y
							class="max-50"
						>
							<template v-slot:activator="{ on }">
								<v-text-field
									v-model="requestData.earliestMonth"
									label="Earliest Month"
									prepend-icon="event"
									v-on="on"
									required
									hint="*Required"
									persistent-hint
									:disabled="!requestData.latestMonth"
								></v-text-field>
							</template>
							<v-date-picker
								v-model="requestData.earliestMonth"
								type="month"
								@input="earliest_month_menu = false"
								:allowed-dates="allowedearliestMonths"
								:disabled="!requestData.latestMonth"
							/>
						</v-menu>
					</v-col>					
					<v-col cols="2">
						<v-autocomplete
							label="Select Aggregation Interva"
							:items="intervals"
							v-model="requestData.interval"
							required
							hint="*Required"
							persistent-hint
						/>
					</v-col>
					<v-col cols="2" class="d-flex justify-center">
						<v-btn
							@click="getData"
							{% comment %} :disabled="Object.values(requestData).includes(null) || !requestData.variableIds.length"							 {% endcomment %}
							> Request Data <v-icon right>send</v-icon> </v-btn>
					</v-col>										
				</v-row>				
			</form>

			<div>


				<template>
					<v-card v-if="requestedData.responseData">
						<v-tabs v-model="tab" bg-color="primary" class="justify-center">
							<v-tab v-for="variableId in requestedData.variableIds" :key="variableId" :value="variableId">
								[[ variableList.find(variable => variable.id==variableId)?.name ]]
							</v-tab>
						</v-tabs>
				
						<v-card-title> [[ ]] </v-card-title>
						<v-card-text>
							<template>
								<v-data-table
									:headers="dataTable.headers"
									:items="dataTable.data"
								></v-data-table>
							</template>
						</v-card-text>
					</v-card>
				</template>
			</div
		</v-app>
	</div>
</div>

{% endblock %} {% block localjavascript %}
 
<script>
	Vue.use(window.vuelidate.default);
	const { required, minLength } = window.validators;

	new Vue({
		el: "#app",
		vuetify: new Vuetify(),
		delimiters: ["[[", "]]"],
		validations: {
		},
		data: {
			now: moment().format('YYYY-MM-DD'),
			tab: null,
			requestData: {
				stationId: {{station_id}},
				variableIds: {{variable_ids | safe}},
				interval: null,
				latestMonth: null,
				earliestMonth: null,
			},
			requestedData: {
				stationId: null,
				variableIds: [],
				interval: null,
				latestMonth: null,
				earliestMonth: null,
				responseData: null
			},
			latest_month_menu: false,
			earliest_month_menu: false,
			radioGroup: 'Month',
			agregations: ['Month', 'Season'],
			month: null,
			months: ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'],
			season: null,
			seasons: ['DJF', 'MAM','JJA', 'SON','Dry', 'Wet', 'Annual'],
			intervals: [
				'week',
				'ten-days',
				'trimester',
				'semester'					
			],
			variableList: {{ variable_list | safe }},
			stationList: [
				{% for station in station_list %}
					{id: {{station.id}}, name: "{{station.name | safe }} - {{station.code}}"},
				{% endfor %}
			],
		},
		watch: {
			'requestData.stationId' (newstationId, oldstationId) {
				// Clear Selected Variables
				this.requestData.variableIds = []
			},
			'requestData.latestMonth' (newlatestMonth, oldlatestMonth) {
				// Clear Selected Variables
				this.requestData.earliestMonth = null
			}
		},	
		computed: {
			filteredVariableList() {
				if (!this.requestData.stationId) return [];
		
				const stationvariableList = {{ stationvariable_list | safe }};
				const variableList = {{ variable_list | safe }};
		
				const stationVariableIds = stationvariableList
					.filter(stationvariable => stationvariable.station_id == this.requestData.stationId)
					.map(stationvariable => stationvariable.variable_id);
				
				return variableList.filter(variable => stationVariableIds.includes(variable.id));
			},
			dataTable () {
				let selectedVariableId = null
				let filteredData = []
				if (!(this.tab===null)){
					selectedVariableId = this.requestedData.variableIds[this.tab];
					console.log(selectedVariableId)
					filteredData = this.requestedData.responseData.filter(entry =>entry.variable_id===selectedVariableId);
					console.log(filteredData)
				}

				return {
					headers: [
						{ text: 'Station', align: 'start', value: 'station' },
						{ text: 'Month', align: 'end', value: 'month' },
						{ text: 'Year', align: 'end', value: 'year' },
						{ text: 'Agg #1', align: 'end', value: 'agg_1' },
						{ text: 'Agg #2', align: 'end', value: 'agg_2' },
						{ text: 'Agg #3', align: 'end', value: 'agg_3' },
					],
					data: filteredData
				}
			},
		},
		methods: { 
			allowedlatestMonths(date){
				return this.now >= date;
			},			
			allowedearliestMonths(date){
				return this.requestData.latestMonth >= date;
			},
			clearSelectedVariables (){
				this.requestData.variableIds = []
			},
			getData(){
				const url = `/wx/agromet/summaries/get/`
        
				this.requestedData.variableIds = this.requestData.variableIds
				this.requestedData.responseData = this.requestData.variableIds
        axios.get(url).then(response => {
					this.requestedData.responseData = response.data
					// this.dataTable.data = response.data
					console.log(response.data)
				})

				
				console.log(this.requestData)
			}
		}		
	})
</script>
{% endblock %}
