{% extends "base.html" %} {% block content %} {% load static %}

<div id="app">
  <v-app v-cloak>
    <v-dialog v-model="dialog" max-width="600" style="z-index:9999;">
      <v-card>
        <v-card-title>History Chart</v-card-title>
        <v-card-text> The chart will apear here...</v-card-text>
        <v-card-actions>
          <v-btn color="primary" @click="dialog = false">Close</v-btn>
        </v-card-actions>
      </v-card>
    </v-dialog>

    <v-layout column>
      <v-flex ml-5 mb-2 lg1>
        <h4> STATIONS MONITORING</h4>
      </v-flex>

      <v-layout>
        <v-flex lg8>
          <l-map ref="myMap" :zoom="zoom" :center="center" :options="options">           
            <l-tile-layer :url="url" :attribution="attribution"></l-tile-layer>
            <l-control
              position="bottomright"
            >
              <template>
                <v-card v-if="selected_method=='Comunication'">
                  <v-card-title class="pa-2"  style="font-size: 12px; line-height: 1.2; color: #444;">Observations from <br/>the pass 24 hours</v-card-title>
                  <v-card-text class="pa-2">
                    <div class="legend-item">
                      <span class="legend-color circle-lg green"> </span>
                      <span> 20 or more </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg yellow"> </span>
                      <span> 8 - 19 </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg red"> </span>
                      <span> 1 - 7 </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg grey"> </span>
                      <span> None </span>
                    </div>                                                    
                  </v-card-text>
                </v-card>
                <v-card v-if="selected_method=='Quality Control'">
                  <v-card-title class="pa-2"  style="font-size: 12px; line-height: 1.2; color: #444;">Observations from <br/>the pass 24 hours</v-card-title>
                  <v-card-text class="pa-2">
                    <div class="legend-item">
                      <span class="legend-color circle-lg green"> </span>
                      <span> Good </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg yellow"> </span>
                      <span> Suspicious </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg red"> </span>
                      <span> Bad </span>
                    </div>
                    <div class="legend-item">
                      <span class="legend-color circle-lg grey"> </span>
                      <span> Not Checked </span>
                    </div>                                                    
                  </v-card-text>
                </v-card>                
              </template>
            </l-control>            
            <l-control-zoom position="topright"></l-control-zoom>
            <l-control position="topleft">
              <template>
                <v-card class="mx-auto" max-width="400">
                  <v-card-title>
                    <span> [[selected_method ]]
                    <v-btn icon @click="reveal = !reveal">
                      <v-icon v-if="reveal">
                        mdi-arrow-up
                      </v-icon>
                      <v-icon v-if="!reveal">
                        mdi-arrow-down
                      </v-icon>                      
                    </v-btn>   
                  </v-card-title>

                  <v-expand-transition>
                    <v-card v-if="reveal" class="mx-auto" style="height: 100%;">
                      <v-card-actions>
                        <v-radio-group v-model="selected_method">
                          <v-radio label="Comunication" value="Comunication"></v-radio>
                          <v-radio label="Quality Control" value="Quality Control"></v-radio>
                        </v-radio-group>
                      </v-card-actions>
                    </v-card>
                  </v-expand-transition>
                </v-card>
              </template>
            </l-control>            
            <l-circle-marker
              v-for="station in markers"
              :lat-lng="station.position"
              radius="7"
              color="white"
              :fill-color="getMarkerColor(station)"
              fill-opacity=1
              weight=2.5
              @click="selectStation(station)"
            >
               <l-popup > [[station.name]]</l-popup>
            </l-circle-marker>             
          </l-map> 
        </v-flex>

        <v-flex style="border-left: 2px solid #BBB;" lg4>
          <div style="background-color: #CCC; display: flex; justify-content: space-between; align-items: center;">
            <h5 style="margin-left: 5%;">  [[selected_station.name]] Station </h5>
            <v-btn icon>
              <v-icon color="blue">
                mdi-open-in-new
              </v-icon>
            </v-btn>                    
          </div>

          <div> 
            <v-tabs v-if="selected_method=='Comunication'" fixed-tabs >
              <v-tab :key="1">
                Data Delays
              </v-tab>
              <v-tab :key="2">
                Latest Values
              </v-tab>

              <!--Station information-->
              <v-tab-item :key="1">
                <v-layout column ma-2>
                  <v-layout ma-2>
                    <span v-if="selected_station.lastupdate">
                      Last update date: [[selected_station.lastupdate]]
                    </span>
                  </v-layout>
                  <v-layout ma-2 >
                    <v-data-table
                      :headers="headers"
                      :items="data_delays"
                      item-key="name"
                      :items-per-page="5"
                      class="elevation-1"

                    >
                      <template v-slot:item.amount="{ item }">
                        <v-chip
                          class="px-5"
                          :color="getItemColor(item.amount)"
                        >
                          [[item.amount]]
                        </v-chip>
                      </template>                               
                      <template v-slot:item.chart="{ item }">
                        <v-tooltip bottom>
                          <template v-slot:activator="{ on }">
                            <v-btn @click="dialog = true" icon>
                              <v-icon color="blue"> mdi-chart-bar </v-icon>  
                            </v-btn>                  
                          </template>
                          <span>Open bar chart</span>
                        </v-tooltip>
                      </template>

                    </v-data-table>
                  </v-layout>
                </v-layout>
              </v-tab-item>

              <v-tab-item :key="2">                
                <v-layout column ma-2>
                  <v-layout ma-2>                
                    <span v-if="selected_station.lastupdate"> Last update date: [[selected_station.lastupdate]] </span>
                  </v-layout>                 
                  <v-layout ma-2>                
                    <span> Coming soon...</span>
                  </v-layout>                  
                </v-layout>                  
              </v-tab-item >

            </v-tabs>
            <v-tabs v-if="selected_method=='Quality Control'" fixed-tabs >
              <v-tab :key="1">
                Flag Amount
              </v-tab>

              <!--Station information-->
              <v-tab-item :key="1">
                <v-layout column ma-2>
                  <v-layout ma-2>
                    <span v-if="selected_station.lastupdate">
                      Last update date: [[selected_station.lastupdate]]
                    </span>
                  </v-layout>
                  <v-layout ma-2 >
                    <v-data-table
                      :headers="headers"
                      :items="data_delays"
                      item-key="name"
                      :items-per-page="5"
                      class="elevation-1"

                    >
                      <template v-slot:item.amount="{ item }">
                        <v-chip
                          class="px-5"
                          :color="getItemColor(item.flags)"
                        >
                          [[item.amount]]
                        </v-chip>
                      </template>                               
                      <template v-slot:item.chart="{ item }">
                        <v-tooltip bottom>
                          <template v-slot:activator="{ on }">
                            <v-btn @click="dialog = true" icon>
                              <v-icon color="blue"> mdi-chart-bar </v-icon>  
                            </v-btn>                  
                          </template>
                          <span>Open bar chart</span>
                        </v-tooltip>
                      </template>

                    </v-data-table>
                  </v-layout>
                </v-layout>
              </v-tab-item>
            </v-tabs>            
          </div>          
        </v-flex> 
      </v-layout>
    </v-layout>
  </v-app>
</div>

{% endblock %} {% block localjavascript %}
<script>  
  var {
    LMap,
    LTileLayer,
    LCircleMarker,
    LControl,
    LControlZoom,
    LMarker,
    LTooltip,
    LControlLayers,
    LPopup,
    LGeoJson,
    LIcon
  } = Vue2Leaflet;

  new Vue({
    el: "#app",
    vuetify: new Vuetify(),
    delimiters: ["[[", "]]"],
    components: {
      LMap,
      LTileLayer,
      LCircleMarker,
      LControl,
      LControlZoom,
      LMarker,
      LTooltip,
      LControlLayers,
      LPopup,
      LGeoJson,
      LIcon
    },
    data () {
      return{
        selected_method: 'Comunication',
        reveal: false,
        dialog: false,
        headers: [
          { text: 'Variable', align: 'start', sortable: false, value: 'variable_name'},
          { text: 'Amout', align: 'center', sortable: false, value: 'amount'},
          { text: 'Chart', align: 'center', sortable: false, value: 'chart'}
        ],
        selected_station: {
          name: null,
          lastupdate: null,
        },
        data_delays: [], 
        timezone: "{{ TIMEZONE_NAME|escapejs }}",
        zoom: "{{ MAP_ZOOM|safe }}",
        center: L.latLng("{{ MAP_LATITUDE|safe }}", "{{ MAP_LONGITUDE|safe }}"),
        url: "https://{s}.tile.osm.org/{z}/{x}/{y}.png",
        attribution: '&copy, <a href="http://osm.org/copyright">OpenStreetMap</a> contributors',
        options: { zoomControl: false },
        method: 'last24h',
        station_list: [],
      };
    },
    mounted(){
      axios.get('/wx/stations/stations_monitoring/get/')
        .then(response => {
          this.station_list = response.data['stations'];
        })
        .catch(error => {
          console.log(error);
        });      
    },
    computed: {
      markers(){
        let filteredMarkers = this.station_list;
        if (this.method == 'last24h')
          filteredMarkers = filteredMarkers.filter(marker => marker.is_active==true);
        return filteredMarkers
      },
    },
    methods: {
      selectStation(station){
        this.selected_station.name=station.name;
        this.selected_station.lastupdate=station.comunication.lastupdate;
        if (this.selected_method=='Comunication'){
          this.data_delays = station.comunication.variables.map(variable => {
            return {
              variable_name: variable.variable_name,
              amount: variable.last24h_ammount,
              lastvalue: variable.last24h_latestvalue,
            };
          });
        }
        else if (this.selected_method=='Quality Control'){
          this.data_delays = station.quality_control.variables.map(variable => {
            return {
              variable_name: variable.variable_name,
              amount: variable.last24h_amount,
              flags: variable.last24h_flags,
            };
          });
        }
      },
      getItemColor(item){
        if (this.selected_method=='Comunication'){
          return this.getColorComunication(item)
        }
        else if (this.selected_method=='Quality Control'){
          return this.getColorQualityControl(item)         
        }
      },
      getMarkerColor(station){
        if (this.selected_method=='Comunication'){
          return this.getColorComunication(station.comunication)
        }
        else if (this.selected_method=='Quality Control'){
          return this.getColorQualityControl(station.quality_control.last24h_flags)
       
        }
      },
      getColorComunication(item){
        if (item.last24h_ammount >= 20){
          return '#3bd424' // Green
        }
        else if (item.last24h_ammount >= 8){
          return '#e8d43f' // Yellow
        }
        else if (item.last24h_ammount >= 1){
          return '#f73e25' // Red
        }
        else{
          return 'grey'
        }
      },
      getColorQualityControl(item){
          if (item.bad > 0){
            return '#f73e25' // Red
          }
          else if (item.suspicious > 0){
            return '#e8d43f' // Yellow
          }
          else if (item.good > 0){
            return '#3bd424' // Green
          }
          else{
            return 'grey'
          }   
      },
    },
  });
</script>

<style>
  .v-data-table .v-data-table-header tr th {
    font-size: 16px !important;
  }

  /* Legend Style */
  .legend-item {
    display: flex;
    align-items: center;
    margin-bottom: 1px;
  }  

  .legend-color {
    display: inline-block;
    width: 20px;
    height: 10px;
    margin-right: 5px;
  }

  .circle-lg {
    display: inline-block;
    width: 13px;
    height: 13px;
    border-radius: 50%;
    margin-right: 5px;
    border: 2px solid white;
  }
</style>

{% endblock %}