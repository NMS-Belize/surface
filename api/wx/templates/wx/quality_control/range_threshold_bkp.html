{% extends "base.html" %} {% block content %}
<div class="srf-container">
  <div id="app" v-cloak>
    <v-app>
      <v-content fluid fill-height style="background: white">
        <v-layout column>
          <div class="srf-flex flex-row align-items-center justify-content-between srf-padding">
            <span class="srf-display-1 text-uppercase">Range Threshold</span
            ><br /><br />
          </div>
          <v-layout column fluid>
            <h6>Station Filters</h6>
            <v-layout dense justify="start" class="mb-3">
              <v-flex lg3 class="text-center">
                <v-autocomplete
                  item-text="name"
                  item-value="name"
                  v-model="filter.stationDistrict"
                  :items="stationDistrictList"
                  label="District"
                  autocomplete="off"
                  clearable
                ></v-autocomplete>
              </v-flex>
              <v-flex lg3 ml-3>
                <v-autocomplete
                  item-text="name"
                  item-value="name"
                  v-model="filter.stationWatershed"
                  :items="stationWatershedList"
                  label="Watershed"
                  autocomplete="off"
                  clearable
                ></v-autocomplete>
              </v-flex>
              <v-flex lg3 ml-3>
                <v-autocomplete
                  item-text="name"
                  item-value="id"
                  v-model="filter.stationProfile"
                  :items="stationProfileList"
                  label="Profile"
                  autocomplete="off"
                  clearable
                ></v-autocomplete>
              </v-flex>

              <v-flex lg1 ml-3>
                <v-switch
                  v-model="filter.isActive"
                  @change="invertValue(filter.isActive)"
                  label="Active"
                ></v-switch>
              </v-flex>

              <v-flex lg1>
                <v-switch
                  v-model="filter.isAutomatic"
                  @change="invertValue(filter.isAutomatic)"
                  label="Automatic"
                ></v-switch>
              </v-flex>
            </v-layout>

            <v-layout mt-3>
              <v-flex lg3>
                <v-autocomplete
                  :items="stationList"
                  item-text="label"
                  item-value="id"
                  v-model="requestObject.station_id"
                  label="Station"
                  @change="getStationVariables(requestObject.station_id)"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>
              </v-flex>

              <v-flex lg6 ml-3>
                <v-autocomplete
                  :items="variables"
                  item-text="variable_name"
                  item-value="variable"
                  v-model="requestObject.variable_ids"
                  label="Variables"
                  multiple
                  clearable
                  :disabled="!requestObject.station_id"
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>
              </v-flex>

              <v-flex lg2 ml-3>
                <v-autocomplete
                  :items="intervalList"
                  item-text="label"
                  item-value="id"
                  v-model="requestObject.interval_id"
                  label="Measurement Interval"
                  required
                  hint="*Required"
                  persistent-hint
                  :rules="simpleTextFieldsRules"
                  autocomplete="off"
                ></v-autocomplete>
              </v-flex>
            </v-layout>

            <v-layout mt-3>
              <v-flex ml-3 mt-5 ml-5 class="d-flex justify-between">
                <v-btn
                  justify-end
                  outlined
                  color="primary"
                  small
                  @click="getThresholdList"
                  >SUBMIT</v-btn
                >
              </v-flex>              
            </v-layout>

            <v-alert v-model="request_error" dismissible type="error">
              [[ request_error_message ]]
            </v-alert>

            <v-overlay :value="loading">
              <v-progress-circular
                indeterminate
                size="64"
              ></v-progress-circular>
            </v-overlay>

            <v-data-table :headers="testHeaders" :items="testInformation" hide-default-footer class="transparent elevation-0 my-4" hide-default-header disable-pagination disable-sort :items-per-page="12">
              <template #header="{ }">
                <thead class="v-data-table-header">
                  <tr>
                    <th v-for="(h,i) in testHeaders" :key="i" class="text-center parent-header td-border-style" :rowspan="h.children?1:2" :colspan="h.children?h.children.length:1">
                      {{ h.text }}
                    </th>
                  </tr>
                  <tr>
                    <th v-for="(h1,i1) in getSubHeader(testHeaders)" :key="i1" class="text-center child-header td-border-style">
                      {{ h1.text }}
                    </th>
                  </tr>
                </thead>
              </template>
              <template #item="props">
                <tr>
                  <td v-for="(c,ci) in getRows(props.item)" :key="ci">
                    {{ c }}
                  </td>
                </tr>
              </template>
            </v-data-table>

          </v-layout>
        </v-layout>
      </v-content>
    </v-app>
  </div>

  {% endblock %} {% block localjavascript %}

  <script>
    Vue.use(window.vuelidate.default);
    const { required, minLength } = window.validators;

    new Vue({
      el: "#app",
      vuetify: new Vuetify(),
      delimiters: ["[[", "]]"],
      validations: {
        requestObject: {
          station_id: { required },
          variable_ids: { required },
          interval_id: { required },
        },
      },
      data() {
        return {
          testHeaders: [
              { text: "Variable", value: "variable_name"},
              { text: "Month", value: "month_name"},
              {
                text: "Global Threshold",
                value: "author",
                divider: true,
                children: [{ text: "Minimum"}, { text: "Maximum"}]
              },
          ],
          testInformation:[
            {
              variable_name: "Precipitation (mm.)",
              month_name: "January",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "February",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "March",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "April",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "May",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "June",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "July",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "August",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "September",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "October",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "November",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
            {
              variable_name: "Precipitation (mm.)",
              month_name: "December",
              author: {
                children: {
                  name: "0",
                  l: "10"
                }
              },
            },
          ],
          loading: false,
          show_dialog: false,
          simpleTextFieldsRules: [
            (v) => (v != null && v !== "") || "This field is required",
          ],        
          request_error: false,
          request_error_message: "",
          requestObject: {
            station_id: null,
            variable_ids: null,
            interval_id: null,
          },
          requestedData: [],
          filter: {
            isActive: true,
            isAutomatic: true,
          },        
          intervalList: [
            {% for interval in interval_list %}
            { id: {{ interval.id }},
              label: "{{ interval.symbol}}",
            },
            {% endfor %}          
          ],
          variables: [],        
          stations: [
            {% for station in station_list %}
            { id: {{ station.id }},
              label: "{{ station.name | safe }} - {{ station.code }}",
              region: "{{ station.region | safe }}",
              watershed: "{{ station.watershed | safe }}",
              profile: "{{ station.profile.id | safe }}",
              is_automatic: {{ station.is_automatic | lower }},
              is_active: {{ station.is_active | lower }},
            },
            {% endfor %}
          ],
          stationProfileList: [
            {% for station_profile in station_profile_list %}
            {id: {{ station_profile.id }}, name: "{{ station_profile.name }}" },
            {% endfor %}
          ],
          stationWatershedList: [
            {% for station_watershed in station_watershed_list %}
            {id: {{ station_watershed.id }}, name: "{{ station_watershed.watershed }}" },
            {% endfor %}
          ],
          stationDistrictList: [
            {% for station_district in station_district_list %}
            {id: {{ station_district.id }}, name: "{{ station_district.name }}" },
            {% endfor %}
          ],
        };
      },
      computed: {         
        stationList () {
          let filteredStations = this.stations;

          if(this.filter.stationDistrict)
            filteredStations = filteredStations.filter(station => station.region == this.filter.stationDistrict);

          if(this.filter.stationWatershed)
            filteredStations = filteredStations.filter(station => station.watershed == this.filter.stationWatershed);

          if(this.filter.stationProfile)
            filteredStations = filteredStations.filter(station => station.profile == this.filter.stationProfile);

          filteredStations = filteredStations.filter(station => this.filter.isAutomatic == station.is_automatic);

          filteredStations = filteredStations.filter(station => this.filter.isActive == station.is_active);

          this.requestObject.station_id = null;

          this.requestObject.station_id = 155;
          this.getStationVariables(this.requestObject.station_id);
          this.requestObject.variable_ids = [0];
          this.requestObject.interval_id = 3;


          return filteredStations;
        }
      },
      methods: {
        getSubHeader(headers) {
          let result = [];
          headers
            .filter((i) => i.children)
            .forEach((v) => {
              result = result.concat(v.children);
            });
          return result;
        },
        getRows(rows) {
          const result = {};
          _.forEach(rows, (i, key) => {
            if (i.children) {
              _.forEach(i.children, (i1, key1) => {
                result["c" + key1] = i1;
              });
            } else result[key] = i;
          });
          return result;
        },
        getAll(path, url, oldData = []) {
          return fetch(`/${path}`)
            .then((res) => {
              if (!res.ok) return res.json().then((err) => Promise.reject(err));

              if (!res.body) {
                return { next: null, results: [] };
              }

              return res.json();
            })
            .then(async (data) => {
              if (data.results != null) {
                const values = [...oldData, ...data.results];
                if (!!data.next) {
                  return await getAll(
                    context,
                    path,
                    `/${path}/${data.next.substr(
                      data.next.indexOf(`/${path}`)
                    )}`,
                    values
                  );
                }
                return values;
              }
            });
        },
        getStationVariables(station_id) {
          this.getAll(`api/stations_variables/?station_id=${station_id}`).then(
            (data) => (this.variables = data)
          );
        },
        invertValue(bool){
          bool = !bool;
        },        
        getThresholdList(){
          this.loading = true; 
          let requested_variables_ids = null;
          if(this.requestObject.variable_ids && this.requestObject.variable_ids.length){
            requested_variables_ids = `${this.requestObject.variable_ids}`
          }
          axios({
            method: 'get',
            url: `/wx/quality_control/range_threshold/get/`,
            params: {
              'station_id': this.requestObject.station_id,
              'variable_ids': requested_variables_ids,
              'interval_id': this.requestObject.interval_id,
            },
          })
          .then(res => {
            this.requestedData = res.data['thresholds'][0]['threshold_list'];
            this.request_error_message = "";
            this.request_error = false;            
          })
          .catch((error) => {
            console.log("error", error.response);
            this.request_error_message = error.response.data.message;
            this.request_error = true;
          })
          .finally(() => {
            this.loading = false;
          });
        },
      },
      mounted() {
        axios.defaults.xsrfHeaderName = "X-CSRFToken";
        axios.defaults.xsrfCookieName = "csrftoken";
      },
    });
  </script>

  <style>
    .firstColumn {
      border-left: 1px solid gray;
    }

    th,
    td {
      padding: 3px;
      padding-left: 10px;
    }

    .v-input--selection-controls__ripple {
      border-radius: 50%;
      cursor: pointer;
      height: 34px;
      position: absolute;
      transition: inherit;
      width: 34px;
      left: -12px;
      top: calc(50% - 24px);
      margin: 7px;
      z-index: 10 !important;
    }

    .v-dialog {
      box-shadow: none;
    }
    .v-dialog__content,
    .v-dialog__content--active {
      z-index: 9999 !important;
    }
    .btn-close-dialog {
      position: absolute;
      top: 116px;
      left: 336px;
      border-radius: 0px 20px 20px 0px;
      z-index: 9999;
      width: 36px;
    }
    .with-divider {
      border-top: 1px solid grey;
      border-bottom: 1px solid grey;
      border-right: 1px solid grey;
      border-left: 1px solid grey;
    }  
  </style>
</div>
{% endblock %}
